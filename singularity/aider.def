BOOTSTRAP: docker
FROM: debian:13

%files

%environment
export PATH=/root/.local/bin:/root/.local/share/uv/tools/aider-chat/bin:$PATH
export PLAYWRIGHT_BROWSERS_PATH=/root/.cache/ms-playwright

%post
set -e
################################# APT INSTALL #################################
export DEBIAN_FRONTEND=noninteractive
mkdir -p /tmp/apt/cache
mkdir -p /tmp/apt/lists
echo 'Dir::Cache "/tmp/apt/cache";' > /etc/apt/apt.conf.d/99custom
echo 'Dir::State::Lists "/tmp/apt/lists";' >> /etc/apt/apt.conf.d/99custom

apt-get update
apt-get install -y --no-install-recommends \
        python3 \
        python3-pip \
        python3-venv \
        build-essential \
        curl \
        git \
        libnss3 \
        libatk-bridge2.0-0 \
        libgtk-3-0 \
        libxss1 \
        fonts-liberation \
        ca-certificates \
        chromium \
        libfontconfig1 \
        libgbm1 \
        libglib2.0-0 \
        libxcomposite1 \
        libxdamage1 \
        libxext6 \
        libxfixes3 \
        libxrandr2 \
        libxkbcommon0 \
        libpangocairo-1.0-0 \
        libatk1.0-0 \
        libcairo2 \
        libcups2 \
        libdrm2 \
        libegl1 \
        libgdk-pixbuf-2.0-0 \
        libgstreamer-plugins-base1.0-0 \
        libgstreamer1.0-0 \
        libharfbuzz0b \
        libjpeg62-turbo \
        libnotify4 \
        libnspr4 \
        libopengl0 \
        libwayland-client0 \
        libwayland-egl1 \
        libwayland-cursor0 \
        libxshmfence1 \
        xdg-utils
###############################################################################

export PATH=/root/.local/bin:$PATH
################################# PIP INSTALL #################################
python3 -m pip config set global.break-system-packages true  # See: https://stackoverflow.com/a/75722775/1679629
mkdir -p /tmp/pip/cache
pip --cache-dir=/tmp/pip/cache install aider-install
aider-install
/root/.local/share/uv/tools/aider-chat/bin/python -m pip install --upgrade --upgrade-strategy only-if-needed aider-chat[playwright]
/root/.local/share/uv/tools/aider-chat/bin/python -m playwright install
cd /root/.local/bin
for f in /root/.local/share/uv/tools/aider-chat/bin/*; do
    filename=$(basename "$f")
    target="/root/.local/bin/$filename"
    if [ -f "$f" ] && [ ! -e "$target" ]; then
        ln -s "$f" "$target"
    fi
done
###############################################################################

# %runscript
# cmd $@

