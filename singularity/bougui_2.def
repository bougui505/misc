BOOTSTRAP: localimage
FROM: bougui.sif

%files

%post
export PIP_CACHE_DIR="/tmp/pip/cache"
mkdir -p "$PIP_CACHE_DIR"
python3 -m pip config set global.break-system-packages true # See: https://stackoverflow.com/a/75722775/1679629

################################# APT INSTALL #################################
export DEBIAN_FRONTEND=noninteractive
mkdir -p /tmp/apt/cache
mkdir -p /tmp/apt/lists
echo 'Dir::Cache "/tmp/apt/cache";' > /etc/apt/apt.conf.d/99custom
echo 'Dir::State::Lists "/tmp/apt/lists";' >> /etc/apt/apt.conf.d/99custom

apt-get update
apt-get install -y python3-open3d
# apt-get install -y python3-pip
###############################################################################

################################# ATOMSURF #################################
cd /opt
git clone https://github.com/Vincentx15/atomsurf.git
cd atomsurf
# Remove open3d from requirements.txt as it's installed via apt-get
sed -i '/open3d/d' requirements.txt
# Update pandas version for compatibility with Python 3.12
sed -i 's/^pandas==1.1.3/pandas==2.2.0/' requirements.txt
# Install diffusion-net-plus and atomsurf requirements as per its README
pip3 install --break-system-packages --cache-dir "$PIP_CACHE_DIR" git+https://github.com/pvnieo/diffusion-net-plus.git
pip3 install --break-system-packages --cache-dir "$PIP_CACHE_DIR" -r requirements.txt
############################################################################

# %runscript
# cmd $@

