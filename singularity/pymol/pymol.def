Bootstrap: docker
From: python

%post
    export DEBIAN_FRONTEND=noninteractive
    
    # Install system dependencies (C++17, CMake, OpenGL, etc.)
    apt-get update && apt-get install -y \
        git \
        build-essential \
        cmake \
        python3-dev \
        python3-pip \
        libglew-dev \
        freeglut3-dev \
        libpng-dev \
        libfreetype6-dev \
        libxml2-dev \
        libnetcdf-dev \
        libglm-dev \
        qtbase5-dev \
        libqt5svg5-dev \
        libxcb-xinerama0

    # Install Python build requirements
    pip3 install --upgrade pip
    pip3 install numpy matplotlib build Pmw mrcfile PyQt5 PyQt5-Qt5 tqdm

    # Clone and Install PyMOL Open Source
    cd /opt
    git clone https://github.com/schrodinger/pymol-open-source.git
    cd pymol-open-source
    
    # Run the installation (this builds the _cmd module)
    # We use --prefix to ensure it is in the system path
    pip3 install .

%environment
    # Set PyMOL path and ensure it runs in headless mode if no display is found
    export PYMOL_PATH=/usr/local/lib/python3.14/site-packages/pymol/pymol_path
    export LC_ALL=C

%runscript
    # Default to running pymol in command line mode
    exec pymol "$@"

%help
    This container runs Open Source PyMOL.
    To run headless: apptainer run <image> -c
    To use in Python: apptainer exec <image> python3 -c "import pymol; print(pymol.__file__)"
