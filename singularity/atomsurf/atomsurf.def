Bootstrap: docker
From: continuumio/miniconda3:latest

%post
    # Create a persistent cache directory on the host if it doesn't exist.
    # This directory will be bind-mounted into the container to store conda packages.
    # The path is hardcoded for simplicity, but could be made configurable.
    mkdir -p /tmp/singularity-conda-cache

%setup
    if [ ! -d atomsurf ];then
        git clone https://github.com/Vincentx15/atomsurf.git
    fi

%files
    atomsurf /opt/atomsurf

%environment
    # Set the default conda environment for convenience
    export CONDA_DEFAULT_ENV="atomsurf"
    # Add the conda environment's bin directory to PATH
    export PATH="/opt/conda/envs/atomsurf/bin:$PATH"
    # Essential for CUDA applications to find libraries, especially when running on a host with NVIDIA GPUs
    export LD_LIBRARY_PATH="/usr/local/nvidia/lib:/usr/local/nvidia/lib64:$LD_LIBRARY_PATH"
    # Set the Python path to include the atomsurf package for proper imports
    export PYTHONPATH="/opt/atomsurf:$PYTHONPATH"

%post
    echo "Creating conda environment 'atomsurf' with Python 3.8..."
    conda create -n atomsurf python=3.8 -y

    echo "Activating conda environment for installations..."
    # Source the conda initialization script to make 'conda activate' available
    . /opt/conda/etc/profile.d/conda.sh
    conda activate atomsurf

    # Set CONDA_PKGS_DIRS to use a bind-mounted cache directory
    # The /opt/conda_cache directory will be bind-mounted from the host during `apptainer build`
    export CONDA_PKGS_DIRS="/tmp/conda_cache"
    mkdir -p "$CONDA_PKGS_DIRS" # Create directory inside container

    echo "Installing PyTorch 1.13 with CUDA 11.7 and PyG 2.3.0 dependencies..."
    conda install cudatoolkit=11.7 -c nvidia -y
    conda install pytorch=1.13 pytorch-cuda=11.7 -c pytorch -c nvidia -y
    conda install pyg=2.3.0 pytorch-scatter pytorch-sparse pytorch-spline-conv pytorch-cluster -c pyg -y

    # Install build tools, as some pip packages might compile C extensions
    echo "Installing compilers and build tools..."
    conda install -c conda-forge compilers -y

    echo "Installing system-level development headers for crypt.h..."
    apt-get update && apt-get install -y libcrypt-dev
    rm -rf /var/lib/apt/lists/* # Clean up apt caches

    # Ensure crypt.h is found by the conda compilers during pip installations
    export C_INCLUDE_PATH="/usr/include:$C_INCLUDE_PATH"

    # Install pyg-lib using pip, ensuring it targets the correct PyTorch/CUDA version
    pip install pyg-lib==0.4.0 -f https://data.pyg.org/whl/torch-1.13.0+cu117.html

    echo "Installing diffusion-net-plus..."
    pip install git+https://github.com/pvnieo/diffusion-net-plus.git

    echo "Installing other dependencies from requirements.txt..."
    # Change to the application directory to find requirements.txt
    (cd /opt/atomsurf && pip install -r requirements.txt)
    pip cache purge # Clean up pip cache after all pip installations

    # Note: The verification steps are commented out as per the original file.
    # echo "Verifying AtomSurf installation by running the example script (this may generate output files)..."
    # (cd /opt/atomsurf && export PYTHONPATH="/opt/atomsurf:$PYTHONPATH" && python example.py)

    # echo "Verifying CUDA availability (requires NVIDIA drivers on host to return True)..."
    # python -c "import torch; print(torch.cuda.is_available())"

%runscript
    # Bind the host cache directory to the container's cache directory
    # The /tmp/singularity-conda-cache on the host will be available as /opt/conda_cache inside the container during build.
    # This also allows the user to specify a custom cache location during `apptainer run` or `apptainer shell`
    # by using --bind /my/custom/cache:/opt/conda_cache
    if [ ! -d /tmp/singularity-conda-cache ]; then
        mkdir -p /tmp/singularity-conda-cache
    fi
    exec apptainer shell --bind /tmp/singularity-conda-cache:/opt/conda_cache "$@"

%labels
    Description AtomSurf: Learnable protein structure encoder jointly encoding graphs and surfaces.
    Homepage https://github.com/Vincentx15/atomsurf

%startscript
    echo "Starting a shell with the AtomSurf conda environment activated."
    # Change to the application directory
    cd /opt/atomsurf
    . /opt/conda/etc/profile.d/conda.sh
    conda activate atomsurf
    export PYTHONPATH="/opt/atomsurf:$PYTHONPATH"
    exec "$@"

%help
    This Apptainer container provides the AtomSurf environment for protein structure encoding.

    Usage:
        apptainer shell <image_name>
            Spawns an interactive shell inside the container, starting in /opt/atomsurf,
            with the atomsurf conda environment activated.

        apptainer exec <image_name> <command>
            Executes a command inside the container with the atomsurf conda
            environment activated, starting in /opt/atomsurf. For example:
            apptainer exec <image_name> python atomsurf/tasks/masif_ligand/train.py

    The source code for AtomSurf is located at /opt/atomsurf.
    The example data and any generated output from example.py will be in /opt/atomsurf/example_data.
