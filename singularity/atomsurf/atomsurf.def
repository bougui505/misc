BOOTSTRAP: docker
FROM: debian:12.1

%setup
    if [ ! -d atomsurf ];then
        git clone https://github.com/Vincentx15/atomsurf.git
    fi
    sed -i 's/^pandas==1.1.3$/pandas/' atomsurf/requirements.txt
    sed -i 's/^deltaconv==1.0.2$/deltaconv/' atomsurf/requirements.txt

%files
    atomsurf /opt/atomsurf

%post
################################# APT INSTALL #################################
export DEBIAN_FRONTEND=noninteractive
mkdir -p /tmp/apt/cache
mkdir -p /tmp/apt/lists
echo 'Dir::Cache "/tmp/apt/cache";' > /etc/apt/apt.conf.d/99custom
echo 'Dir::State::Lists "/tmp/apt/lists";' >> /etc/apt/apt.conf.d/99custom

apt-get update
apt-get install -y python3-pip git build-essential python3-dev cmake
###############################################################################

################################# PIP INSTALL #################################
TORCH="2.6.0"
CUDA="cu124"
python3 -m pip config set global.break-system-packages true  # See: https://stackoverflow.com/a/75722775/1679629
mkdir -p /tmp/pip/cache
python3 -m pip config set global.cache-dir /tmp/pip/cache
pip3 install torch==${TORCH} --index-url https://download.pytorch.org/whl/${CUDA} --extra-index-url https://pypi.org/simple
pip3 install torch_scatter torch_sparse torch_spline_conv torch_cluster
pip3 install pyg-lib -f https://data.pyg.org/whl/torch-${TORCH}+${CUDA}.html
pip3 install torch_geometric
###############################################################################

cd /opt/atomsurf
pip3 --cache-dir=/tmp/pip/cache install git+https://github.com/pvnieo/diffusion-net-plus.git
pip3 --cache-dir=/tmp/pip/cache install -r requirements.txt

# %runscript
# cmd $@

